---
title: "AIワークフローの実装"
emoji: "📜"
type: "tech"
topics: ["OPA", "Policy", "Rego", "Agent"]
published: false
---

この記事はアドベントカレンダー「Goで作るセキュリティ分析生成AIエージェント」の15日目です。

今回のコードは https://github.com/m-mizutani/leveret の [day15-workflow](https://github.com/m-mizutani/leveret/tree/day15-workflow) ブランチに格納されていますので適宜参照してください。

# AIワークフローとは

- ここでは、一般的なワークフローエンジン・管理ツールに生成AI機能を足したものと定義する
  - ワークフローエンジンとは処理、入出力、条件分岐などの処理を接続して一連の手続き・業務を表現・実行するもの
  - 処理や入出力には外部サービスとの連携も含まれる、というかそっちが本題
  - AIが組み込まれたものの他の呼び名としては、AIアプリケーションビルダー / LLMオーケストレーション / AIエージェントフロー、みたいな呼び方をされている
  - OSSだとn8n、Difyなどが挙げられる
  - 直接コードを書くより簡単に表現できるというのがポイント
    - DSLで記述したり、GUI上で設定するなどがある
    - コーディングができない・したくない人に有用
- AIを利用する役割は大きく分けると3つ
  - データの加工
    - 雑多な自然言語を構造化データに直したり、特定のキーワードを抽出したり、なんらかの法則でデータを変換するなど
    - 既存のワークフローでの処理はだいたいがルール記述によって決定性のある処理をできる
    - ただしfuzzyなデータを扱う場合だとルール書くのがメチャクチャ大変
    - 自然言語とかどうにもならん
    - これを生成AIだとかなりいい感じに構造データに変換したりしてくれる
    - 自然言語 → 自然言語ももちろんある
      - 通知文面作成みたいな
  - 条件分岐判定
    - やっていることはデータ加工と本質的には同じだが、目的がちょっと違う
    - これもいままでは個別にルールをかかないといけなかったが、fuzzyな判定に使うことができる
      - もちろんクリティカルな業務に使うことはできないが
  - エージェント処理
    - 他システムにアクセスする系
    - 調査する：データ収集、収集対象を自分で判断したりする
    - 作成・変更する：ドキュメント作成、チケット作成、スケジュール作成などなど

# セキュリティ分析で利用するワークフロー

- これはようするにSOARです
  - ただしSOARは死んだ。SOAR is dead
  - そこでSOAR＋AIにするといろいろ軽減される
- ただしSOAR＋AIで全て解決するわけではない
  - やはりルールを書くのが大変
  - そもそもルール書かなくてもエージェントに命令するだけでだいたいよしなにやってくれる
  - エージェントは伴走する存在。SOARはそういうのじゃない
- それでもワークフローはほしい理由
  - 決定性のある処理は決定性をもってやったほうがよい
    - 例えば生成AIで特定条件を無視させる、みたいなのも概ねうまくいくが一抹の不安がある
    - 確実性をもって処理するための仕組みは欲しい
      - なんならルールを生成AIに書かせて人間がレビューすればよい。それで基本の動作は保証できる
  - セキュリティ分析だと特にアラートの事前処理をしたい
    - 初期トリアージ

# ワークフローを独立して実装する必要があるのか？

- わざわざワークフロー機能とか言ってないで、普通にコードで表現すればいいんでは？
  - それはそう
  - だいたいのユースケースや要件はそれで充足する
  - しかしワークフローとして分離しておいたほうが良いケースも有る
- ワークフローを別の系で実装したほうがよい理由
  - ロジックを（やや）平易に表現できる
  - ランタイムとロジックを分離できる
    - 実装分離が明確化されているとコード上の整理としては良い。リファクタなどがしやすくなる
    - ランタイム実装者とロジック実装者を切り分けられる。より運用寄りの人がロジックをいじりやすくなる

# まとめ
