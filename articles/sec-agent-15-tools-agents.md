---
title: "セキュリティ分析のためのツール・サブエージェント"
emoji: "🔧"
type: "tech"
topics: ["ai", "go", "security", "agent"]
published: false
---

この記事はアドベントカレンダー「Goで作るセキュリティ分析生成AIエージェント」の15日目です。本日はAIエージェントの実装から少し離れ、セキュリティ分析エージェントが利用すると便利そうなツール、ないしはサブエージェントとしてどのようなものがあるかについて、説明します。

- ここまでAIエージェントを実装する目的でadhocにツールやエージェントを追加してきた
- 今回はそもそもどういうツール、エージェントが役に立ちそうかとそれらの実装のポイントについてまとめる
- あくまで筆者の経験によるものであり、必ずしもここにあるものだけが全てではない
  - むしろもっと良いツールのアイディアがあれば筆者に教えてね

# セキュリティ分析に必要なツール・エージェントの種類

- 基本的にツール・サブエージェントなどの区別なしに解説する
- ただしどっちがオススメかなどがある程度明確である場合はそれについても言及する

## (1) IoC検索

- 脅威情報DBから出現したIoCの情報を検索する
- 言わずもがな出現した各種indicatorとIoCの突き合わせ検索をすることで、影響の見立てを立てやすくなる
- 外部サービスからAPIを通じてそのまま取得する場合は単純にそのwrapperを実装するだけで良い
  - これはday 09で実装したものとだいたい一緒
  - 特にひねることもなく、ツールとして実装するだけでいい
- 一方でfeedであったりリストだけで提供されているものについては工夫が必要
  - これについては内部にDBを構築して検索可能な状態にする必要がある
  - 定期的にDBを洗い替えしたり、新規のものだけを追加するといったような管理をしなければならない
  - クラウドでやるならkey-value型のドキュメント志向DBを利用するのが比較的オススメ
    - 例えばDynamoDBだと1日100万件読んでも月あたり$4ちょいですむ

## (2) ログデータ検索

- ログデータの取得等に関する話は[実践セキュリティ監視基盤構築](https://zenn.dev/mizutani/books/secmon-platform) にも詳細が書かれているので参考にしてね
- インフラ、プロダクト、端末、社内システムのログデータ検索をしたい
  - インフラ
    - cloud platform（AWS, Google Cloud）のaudit log
    - network flow logs, DNS logs, etc.
    - fw, load balancerからなどのログ
  - プロダクト
    - 外部に提供しているプロダクト
    - アプリケーション的なログというよりは監査ログやログインなどに関するログがよい場合が多い
    - もちろん監視要件によってはアプリそのものもログも必要
  - 端末
    - EDRやシステムモニタリングのログ
    - あとはMDMのようなものもあればなおよし
  - 社内システム
    - オンプレ、SaaSかかわらず
    - どっちの場合もほとんどは監査ログをどこかに転送してDWH化する必要がある
- Alertに登場した対象のユーザやリソースにどのような事が起こったのかを調べる
  - そのユーザはどのような行動をしていたか？
  - そのリソースにアクセスしたものがいるか？
  - そのリソースが不審な行動をしていたか？
  - そのリソースはいつどのような変更があったのか？
  - このあたりの関連しそうな情報を引き抜いてくるところはかなりエージェントでできる
- サブエージェント実装でも解説したが、コンテキストウィンドウを消費しやすい
  - そのためサブエージェントとして実装するのがオススメ
  - サブエージェントでも検索に色々条件をつけるなどしてコンテキストウィンドウ消費を抑えるとよい
- 検索に関するヒントをなるべく沢山与える必要がある
  - これもサブエージェントでやったが、とりあえずスキーマを渡しただけだとなんもできない
  - 可能ならどのフィールドがどういう意味を持つか、どういう形式のデータが格納されているか、どういう条件でデータが入っているかなどをちゃんと説明した方が良い
  - またfew-shot promptingの応用として成功事例を提示するとそれを参照してくれる
  - とにかく人間がやってもだめなものはAIがやってもだめなので、適切な情報を注入することに注意を払う
- ポイントとして、ログ検索結果がコンテキストウィンドウを消費すると思われがちだが、意外とスキーマ情報が重い
  - 例えばGoogle CloudのauditログとかはBigQueryにいれると平気で数千カラムこえる
  - これだけでコンテキストウィンドウをかなり圧迫する
  - 他にもEDRログとかは項目数が多くなりがちだったりする
  - 事前に与えるスキーマ情報を限定しておくという手もある。ただし面倒くさい＆最新のスキーマに追随しなければならないみたいな面倒くささがあり、そこはよく考えておく必要がある
- ツールなどのインターフェースは当然ながらログ検索の方法に依存する
  - メジャーな検索クエリについては生成AIで十分生成できる。SQLとかは余裕
  - あまりメジャーではないDWHプロダクトなどを使っている場合は注意が必要。その場合はクエリの構文や仕組みについてまずシステムプロンプトなどで入力する必要がある
  - そういう意味では、生成AI利用も踏まえたログ保持・検索の仕組みを考える必要がある時代

## (3) インフラやシステムの最新状態取得

- 状態：対象リソースが今どういう状況なのか、例えば権限が正しく設定されているのか？見たナノを調べる
- 方法としては主に二通りある
  - 一つはそのサービスなどが提供するAPIを直接叩くやり方
    - 参照系の権限だけ生成AIに渡して勝手に検索させる
    - ある程度メジャーなサービスなら勘所はわかるが、そうでないならいろいろ検索に必要な知識は渡して上げる必要がある
    - 最新の情報を取得できるというメリットが有る
    - ただしrate limitや取得上限にひっかかるという問題はおこりうる点に注意
  - もう一つは定期的にスナップショットを取得してDWHに保存するやり方
    - 頻繁に検索する、あるいは検索対象が多すぎるなどの場合はこの方法がよい
    - たとえばcloudqueryがこの目的では便利
    - あとはgoogle cloudだとcloud asset inventoryをBQへexportするなどしておくとよい
    - 欠点としては定期実行なので遅延は発生する
- これによってリソースが今どういう状況かなどを調べることができる
  - よくみるのは権限の設定。適切に設定されているかや、危殆化したとしてどういう影響があるか
  - あとは設定ミスに関するアラートがあったとき、今現在もそうなのか確認する

## (4) 開発リポジトリの情報取得

- プロダクトに対するセキュリティに責任を保つ場合、開発リポジトリ内にあるコードの状況や開発者のやりとりなどを検索できると便利
- 基本的には検索できるとよい
  - 構成管理でIaCを使っている場合、設定ミスを疑われるものがあったらそれが意図的に実施されたものなのかをコードや変更履歴から読み取ることができる
  - また何か影響のある変更があった場合、いつから変更があったかを知ることができる
  - アプリケーションの変更に関しても、なにか問題があったときにいつから変更されたのか、意図的に変更されたのかを知ることができる
  - 攻撃に対して影響があったのかソースコードを追跡するというのもできそうな気もするが、実際にはアラートの情報が完全ではなく難しいことが多い
- 別アプローチとしてスキャン結果やある時点での状態をDWHに保存しておき、検索するという手もある
  - 筆者は[octovy](https://github.com/secmon-lab/octovy)をGitHub Appsとしてしかけ、全リポジトリで利用している3rd party package情報をBQにつっこんでいる
  - サプライチェーン攻撃があったときにこれを検索させると影響のあったパッケージが社内で使われているかを即座に判定できて便利

## (5) 社内ドキュメントの検索

- 社内に関するポリシーや決められた手順などをエージェントが知ることができる
- ただし扱いはやや難しく、どういう情報があるかを事前に教えておかないといけない（以前説明した通り「知らないものは探さない」）
- 使う場合は、〜という情報はこのツールを使って検索せよ、というぐらいの情報をあらかじめ提示しておく必要がある
- あるいはシステムプロンプトに事前に埋め込んでいまうというのもあり
- あと利用しているドキュメントサービスの検索性がいけているかどうかも結構重要
  - そもそも検索がだめな場合は当然AIエージェントにやらせてもだめ
  - それだったら素直にリンクなどを用意して勝手に取得させるのがよい

## (6) 社内コミュニケーション記録の検索

- 例としてはSlackや自動生成議事録など
- 意外といろいろ役に立つ
  - 何か構成変更があった場合にそれがどのような意図だったか判定
  - 社内で見慣れないサービス、アプリケーションの情報があった場合その出どころを調べる
  - 社内でそのツールが使われているかどうかを確認するとか

## (7) Web検索＆ページ取得ツール

- あると便利
- ただしURLなどのIoCを踏み抜く可能性がある
- また攻撃に関する情報を無邪気に検索クエリに含めてしまう可能性もある
- プロンプトである程度はガードできるが完全ではない
- そのためこのツールは筆者にとってもまだ結構未知数
- 実装するならサブエージェントのほうがいいかもしれない

## まとめ

本日はセキュリティ分析エージェントに組み込むと有用なツール・サブエージェントについて、7つのカテゴリに分けて解説しました。これらは筆者の実運用経験に基づくものですが、重要なのは「どのツールを実装するか」ではなく、**自組織のセキュリティ分析業務で何が必要かを見極める**ことです。

特に押さえておくべきポイントは以下の通りです:

- **コンテキストウィンドウとの戦い**: ログ検索やスキーマ情報はコンテキストウィンドウを大量に消費します。サブエージェント化や事前のスキーマ限定など、設計段階から対策を講じる必要があります
- **「知らないものは探さない」原則**: AIエージェントは人間と同じで、存在を知らないツールや情報源は使えません。システムプロンプトやツール説明で明示的に導く必要があります
- **生成AI時代のログ基盤設計**: SQLのようなメジャーなクエリ言語は生成AIが得意ですが、独自DSLを使うDWHは苦手です。ツール選定時に生成AI適性も考慮すべき時代になっています

明日以降は、これらのツール・サブエージェントを効果的に組み合わせるワークフロー設計について解説していきます。今日紹介したツール群を「いつ」「どのように」呼び出すかという、より高度なオーケストレーションの話に進みます。

セキュリティ分析エージェントの価値は、個々のツールの性能ではなく、**適切な順序で適切なツールを呼び出し、情報を統合して判断する能力**にあります。自組織に必要なツールのリストアップができたら、次はそれらをどう連携させるかを考えていきましょう
