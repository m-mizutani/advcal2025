---
title: "AIワークフロー (1) - 設計"
emoji: "📜"
type: "tech"
topics: ["Workflow", "SOAR", "AI", "Agent"]
published: false
---

この記事はアドベントカレンダー「Goで作るセキュリティ分析生成AIエージェント」の16日目です。

今回のコードは https://github.com/m-mizutani/leveret の [day16-workflow-design](https://github.com/m-mizutani/leveret/tree/day16-workflow-design) ブランチに格納されていますので適宜参照してください。

# AIワークフローとは

- ここでは、一般的なワークフローエンジン・管理ツールに生成AI機能を足したものと定義する
  - ワークフローエンジンとは処理、入出力、条件分岐などの処理を接続して一連の手続き・業務を表現・実行するもの
  - 処理や入出力には外部サービスとの連携も含まれる、というかそっちが本題
  - AIが組み込まれたものの他の呼び名としては、AIアプリケーションビルダー / LLMオーケストレーション / AIエージェントフロー、みたいな呼び方をされている
  - OSSだとn8n、Difyなどが挙げられる
  - 直接コードを書くより簡単に表現できるというのがポイント
    - DSLで記述したり、GUI上で設定するなどがある
    - コーディングができない・したくない人に有用
- AIを利用する役割は大きく分けると3つ
  - データの加工
    - 雑多な自然言語を構造化データに直したり、特定のキーワードを抽出したり、なんらかの法則でデータを変換するなど
    - 既存のワークフローでの処理はだいたいがルール記述によって決定性のある処理をできる
    - ただしfuzzyなデータを扱う場合だとルール書くのがメチャクチャ大変
    - 自然言語とかどうにもならん
    - これを生成AIだとかなりいい感じに構造データに変換したりしてくれる
    - 自然言語 → 自然言語ももちろんある
      - 通知文面作成みたいな
  - 条件分岐判定
    - やっていることはデータ加工と本質的には同じだが、目的がちょっと違う
    - これもいままでは個別にルールをかかないといけなかったが、fuzzyな判定に使うことができる
      - もちろんクリティカルな業務に使うことはできないが
  - エージェント処理
    - 他システムにアクセスする系
    - 調査する：データ収集、収集対象を自分で判断したりする
    - 作成・変更する：ドキュメント作成、チケット作成、スケジュール作成などなど

# セキュリティ分析で利用するワークフロー

- これはようするにSOARです
  - ただしSOARは死んだ。SOAR is dead
    - SOAR is deadの話は以前に解説した通り
  - そこでSOAR＋AIにするといろいろ軽減される
- ただしSOAR＋AIで全て解決するわけではない
  - やはりルールを書くのが大変
  - そもそもルール書かなくてもエージェントに命令するだけでだいたいよしなにやってくれる
  - エージェントは伴走する存在。SOARはそういうのじゃない
- それでもワークフローはほしい理由
  - 決定性のある処理は決定性をもってやったほうがよい
    - 例えば生成AIで特定条件を無視させる、みたいなのも概ねうまくいくが一抹の不安がある
    - 確実性をもって処理するための仕組みは欲しい
      - なんならルールを生成AIに書かせて人間がレビューすればよい。それで基本の動作は保証できる
  - セキュリティ分析だと特にアラートの事前処理をしたい
    - 初期トリアージ

# ワークフローを独立して実装する必要があるのか？

- わざわざワークフロー機能とか言ってないで、普通にコードで表現すればいいんでは？
  - それはそう
  - だいたいのユースケースや要件はそれで充足する
  - しかしワークフローとして分離しておいたほうが良いケースも有る
- ワークフローを別の系で実装したほうがよい理由
  - ロジックを（やや）平易に表現できる
  - ランタイムとロジックを分離できる
    - 実装分離が明確化されているとコード上の整理としては良い。リファクタなどがしやすくなる
    - ランタイム実装者とロジック実装者を切り分けられる。より運用寄りの人がロジックをいじりやすくなる
- 実際にはソースコード上ので実装で十分な場合もあるが、今回はあえてワークフローを別で実装してみる


# セキュリティアラートに対応するワークフローの設計

- まじめにワークフローエンジンを作ろうとすると超大変
- 自由度を高めるために大量の機能を作る必要がある
- しかし今回はユースケースがはっきりしているので、それに応じたワークフローを作る

## ユースケースの整理

- このワークフローは外部システムからアラートを受け取るたびに実行されるものとする
  - 今回はあくまで学習のため実装しやすさを優先してCLIチャットとして実装しているが、本来はアラートが発生したらそれを受信 → 処理するためのサービスとして実装するのがよい
  - そのためアラートが発生するたびに、自動的に何かしらの処理を実行したいというのがユースケース
- 逆にワークフローが実行されるのはアラート到着時だけでよい
  - SOARだと例えば人間が任意のタイミングでトリガするようなユースケースも組むことができる
  - しかし人間が指示するならAIエージェントで十分説がある
    - やるとしてもあらかじめ用意しておいたプロンプトを実行するようなもの、AIコーディングエージェントで用意されているカスタムコマンドに近い概念で十分ではと考える
    - これについては今回のアドベントカレンダーでは実装しないが実装する価値があることだけは言及しとく
  - もちろん定型業務がバチッと決まっているような場合は実装する価値はある
    - ただその場合はセキュリティ分析エージェント内に実装するのではなく、フローを外部に要して叩く方法も検討しうる
    - なぜならそういうタイプのワークフローはだいたい外部干渉系のワークフローである
      - 例えばFWのルールを変える、インスタンスを停止する、EDRの機能で端末に干渉する、などなど
      - そういうワークフローは強い権限を持つのでセキュリティ分析エージェントとは切り離し、実行アカウントの権限を分離しておいたほうがよい
        - これは単純に最小権限化というのもあるが、セキュリティ分析エージェントはいろんなツールを使う際に誤って強い権限が発動されると怖いので、エージェントの実行アカウントは読込系を中心にしておいたほうがいいよ

## 具体的なワークフロー機能

セキュリティ分析において、アラート受信時にするタスクは主に3つ考えられる

### (1) アラートの解釈

- 取得したアラートの内容を解釈する
- 分析云々ではなくアラート本文データ内にある項目を変換したり、共通の項目へ置き換える正規化など
- アラートの要約を作成させたりするのもこれにあたる
  - タイトルや要約作成は以前にやったね
- そもそも受信したものをアラートとして扱うかどうか（無視してもいいか）という判断も含まれる

### (2) 関連情報の収集

- SOARなどでユースケースが多いやつの一つ。enrichと呼ばれることが多い
- 各所からそのアラートに関連しそうな情報を収集して、そのアラートに付与する
  - 脅威情報DBから出現したIoCの情報を検索する（リモート、ローカル問わず）：言わずもがな出現した各種indicatorとIoCの突き合わせ検索をすることで、影響の見立てを立てやすくなる
  - インフラ、システム、アプリ、端末、外部サービスのログデータ検索：Alertに登場した対象リソースにどのような事が起こったのかを調べる
  - インフラやシステムの状態：対象リソースが今どういう状況なのか、例えば権限が正しく設定されているのか？見たナノを調べる
  - 開発リポジトリの検索：プロダクトに対するセキュリティに責任を保つ場合、開発リポジトリ内にあるコードの状況や開発者のやりとりなどを検索できると
  - 社内ドキュメント、コミュニケーション

### (3) 初動反応
