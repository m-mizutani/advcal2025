---
title: "エージェント実行の高度な制御 (1) 計画駆動パターン"
emoji: "📋"
type: "tech"
topics: ["ai", "go", "llm", "agent"]
published: false
---

この記事はアドベントカレンダー「セキュリティ分析LLMエージェントの実装」の18日目です。

今回のコードは https://github.com/m-mizutani/leveret の [day18-plan-execute](https://github.com/m-mizutani/leveret/tree/day18-plan-execute) ブランチに格納されていますので適宜参照してください。

# 生成AIエージェントの実行における迷走

- LLMの短く明確なタスクだと、以前に実装したFunction Callingのループで問題なく完了してくれる
- しかし、やや複雑な処理だったり、複数の要件が発生するようなタスクだと急に迷走をはじめる
  - 横道にそれはじめて目的を見失う
  - なんか頑張っているがよくわからないことを延々と続ける
- なぜこんなことが起きるのか？
  - プロンプトに目的が含まれていても部分的に忘れる Lost in the middle現象など
    - 入力データが大きくなりすぎると真ん中あたりの情報の優先度が低くなる現象
  - コンテキストが長くなりすぎた結果、ヒストリが compression される過程で目的が見失われてしまう
    - 要約で適切に目的を残すように指示しても、文脈が失われたりしてしまう
      - 大量データを要約しようとすると難しい
    - trimとかだともっと深刻な問題に
  - 直近のヒストリに影響されるので、一度おかしな推論をしたり仮説を立てたりすると、そのまま突き進んでいく
    - そのまま返ってこなくなることもしばしば
- LLMエージェントの

# 生成AIエージェントの行動思考手法

- こうした迷走を防ぐために生成AIエージェントを実行する際にエージェントの行動を制御する手法がいくつか存在する
- LLM Agent Architectures, Reasoning strategiesなどと呼ばれる
- 本アドベントカレンダーでは「行動思考手法」と呼ぶ
  - 行動思考手法は多岐にわたる
- 具体的には、単純にツール実行を繰り返すのではなく、ツール実行の合間にさらに生成AIによるコンテンツ生成を挟み込み、その結果によって次の行動の選択を方法の総評
  - ここまでの要約を与えたり、フルHistoryを与えたりなど手法は様々だが、とにかくタスクの実行とは別に実行方針制御も生成AIでやる、というのがポイント
  - （ここに単純ループと行動思考手法の違いのフローチャートを書く）
- 筆者の認識だとメジャーなものは以下辺り
  - **ReAct (Reason + Act)**:
    - 汎用的に使える思考＋実行を繰り返す手法
    - function callingと比較すると、ReActは思考過程をテキストとしてhistoryに含められる一方、function callingは構造化されたJSON形式で確実にツールを呼び出せる
      - ReActの利点は推論ステップを明示的にプロンプトに示して制御することだが、本質的にはhistory管理の一種である
  - **Plan & Execute**:
    - 計画フェーズと実行フェーズを分離することで計画に沿ったタスクをこなす
    - 安定的に動作する反面、探索的なタスクには弱い
    - 初期計画が静的なため、予期しない状況への適応が困難であり、タスクが順次実行されるため並列化による高速化も制限される
  - **Reflexion**
    - 自己評価・改善ループ型
    - 実行するたびに結果が目的を達成したか？というのを確認し、だめなら内省する
    - それをもとに再実行を繰り返す
    - 探索的な処理に適している
- 研究分野も含めるとより多様な手法がある
  - 今回の記事では各手法の詳細には踏み込まない
  - また最新の研究成果は追随できていない（し、それをここで書いてもあっという間に陳腐化する）
  - 興味がある人は自分で最新の情報を調べてくれ
- 2025年現在の最新のエージェントでは、これらの手法を組み合わせたり、必要に応じて切り替えたりしながら利用している
  - 例えばタスクによって手法を変えるとか
  - ある手法のなかでのツール実行を別の行動思考手法で制御するとか
  - 万能な行動思考手法はなく、最適手法に関しての研究が進んでいる

# Plan & Executeパターンの利用

## なぜ Plan & Executeパターンなのか

- これは対象とする「セキュリティアラートの分析」というユースケースに依存する
- 「セキュリティアラートの分析」のユースケース
  - まずセキュリティアラートが飛んでくる
    - この時点でなにか問題が発生している可能性が示唆されている
    - そして基本的に問題に関する手がかりが記されている
  - 次にするべきは

## 基本的な考え方

## 

- 並列実行は今回扱わない


# まとめ
