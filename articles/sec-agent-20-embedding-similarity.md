---
title: "Goã§ä½œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ(20): Embeddingã«ã‚ˆã‚‹é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œç´¢"
emoji: "ğŸ”"
type: "tech"
topics: ["ai", "go", "llm", "rag"]
published: false
---

ã“ã®è¨˜äº‹ã¯ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€Œ[Goã§ä½œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ](https://adventar.org/calendars/11354)ã€ã®20æ—¥ç›®ã§ã™ã€‚

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ https://github.com/m-mizutani/leveret ã® [day20-embedding](https://github.com/m-mizutani/leveret/tree/day20-embedding) ãƒ–ãƒ©ãƒ³ãƒã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã®ã§é©å®œå‚ç…§ã—ã¦ãã ã•ã„ã€‚

# Embeddingã«ã¤ã„ã¦

## Embeddingã¨ã¯ãªã«ã‹

Embeddingã¨ã¯ã€ä¸€è¨€ã§è¨€ãˆã°ã€Œè¨€è‘‰ã‚„æ–‡ç« ã®æ„å‘³ã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã™ã‚‹æŠ€è¡“ã€ã§ã™ã€‚ä¼¼ãŸæ„å‘³ã‚’æŒã¤è¨€è‘‰ã‚„æ–‡ç« åŒå£«ãŒã€ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ä¸Šã§è¿‘ã„ä½ç½®ã«é…ç½®ã•ã‚Œã‚‹ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã‚‹ä»•çµ„ã¿ã¨ãªã£ã¦ã„ã¾ã™ã€‚ãŸã¨ãˆã°ã€Œãƒšãƒƒãƒˆã€ã¨ã€ŒçŠ¬ã€ã¯æ„å‘³çš„ã«è¿‘ã„ãŸã‚ãƒ™ã‚¯ãƒˆãƒ«ã®è·é›¢ã‚‚è¿‘ãã€ã€ŒçŠ¬ã€ã¨ã€Œå®‡å®™ã€ã¯æ„å‘³ãŒé›¢ã‚Œã¦ã„ã‚‹ãŸã‚ãƒ™ã‚¯ãƒˆãƒ«ã®è·é›¢ã‚‚é ããªã‚Šã¾ã™ã€‚åŒæ§˜ã«ã€Œãƒšãƒƒãƒˆã€ã¨ã€Œå®‡å®™ã€ã‚‚é ã„é–¢ä¿‚ã¨ãªã‚Šã¾ã™ã€‚

ã“ã†ã—ãŸå˜èªã‚„æ–‡ç« ã®ãƒ™ã‚¯ãƒˆãƒ«åŒ–æŠ€è¡“ã¯ã€ç”ŸæˆAIãŒç™»å ´ã™ã‚‹ä»¥å‰ã‹ã‚‰é•·ãç ”ç©¶ã•ã‚Œã¦ãã¾ã—ãŸã€‚åˆæœŸã®EmbeddingæŠ€è¡“ã§ã‚ã‚‹word2vecã‚„GloVeãªã©ã¯ã€å˜èªå˜ä½ã®ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚’ä¸­å¿ƒã¨ã—ã¦ã„ã¾ã—ãŸãŒã€æ–‡è„ˆã«ã‚ˆã£ã¦æ„å‘³ãŒå¤‰ã‚ã‚‹å¤šç¾©èªã¸ã®å¯¾å¿œãŒå¼±ãã€æ–‡å…¨ä½“ã®ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚‚è‹¦æ‰‹ã¨ã„ã†åˆ¶ç´„ãŒã‚ã‚Šã¾ã—ãŸã€‚

ãã®å¾Œã€æ–‡ç« ã®æµã‚Œï¼ˆæ–‡è„ˆï¼‰ã‚’æ‰ãˆã‚‹ãŸã‚ã«RNNã‚„LSTMã¨ã„ã£ãŸãƒ¢ãƒ‡ãƒ«ãŒç™»å ´ã—ã€æ–‡å…¨ä½“ã®æ„å‘³ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã—ã‹ã—é•·æ–‡ã«ãªã‚‹ã¨ç²¾åº¦ãŒè½ã¡ã‚‹ã¨ã„ã†èª²é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã—ãŸã€‚

ã“ã®çŠ¶æ³ã‚’å¤§ããå¤‰ãˆãŸã®ãŒTransformerã®ç™»å ´ã§ã™ã€‚Transformerã«ã‚ˆã£ã¦æ–‡ä¸­ã®æ„å‘³ã®ã¤ãªãŒã‚Šã‚’åŠ¹ç‡è‰¯ãç†è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€æ–‡è„ˆã‚’è€ƒæ…®ã—ãŸé«˜ç²¾åº¦ãªEmbeddingãŒå®Ÿç¾ã•ã‚Œã¾ã—ãŸã€‚Transformerã¯BERTã‚„GPTãªã©ã®å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã«ã‚‚æ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ç¾åœ¨ã®LLMã«ãŠã‘ã‚‹é‡è¦ãªåŸºç¤æŠ€è¡“ã®ä¸€ã¤ã§ã™ã€‚ã“ã®ãŸã‚ã€LLMã‚µãƒ¼ãƒ“ã‚¹ã¨ä¸€ç·’ã«Embeddingæ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã‚‹ã“ã¨ãŒå¤šããªã£ã¦ã„ã¾ã™ã€‚ãŸã¨ãˆã°Geminiã‚„OpenAIã¯ãã‚Œãã‚ŒEmbeddingæ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ä¸€æ–¹ã€Claudeã¯2025å¹´ç¾åœ¨ã§ã¯Embeddingæ©Ÿèƒ½ã‚’ç›´æ¥æä¾›ã—ã¦ãŠã‚‰ãšã€[Voyage AI](https://www.voyageai.com/)ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚

è©³ã—ã„ç†è«–ã«ã¤ã„ã¦ã¯ã“ã®ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç¯„å›²ã‚’è¶…ãˆã‚‹ãŸã‚æ‰±ã„ã¾ã›ã‚“ãŒã€èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯èª¿ã¹ã¦ã¿ã¦ãã ã•ã„ã€‚

## RAGï¼ˆRetrieval Augmented Generationï¼‰ã¨ã¯ãªã«ã‹

RAGï¼ˆRetrieval Augmented Generationï¼‰ã¨ã¯ã€ä¸»ã«Embeddingæ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã€LLMã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆæ™‚ã«å¿…è¦ã¨ãªã‚‹æƒ…å ±ã‚’æ¤œç´¢ã—ã¦ã€ãã‚Œã‚‰ã‚’ã‚‚ã¨ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ‹¡å……ã™ã‚‹æŠ€è¡“ã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ç·ç§°ã§ã™ã€‚

ã“ã‚Œã¾ã§ã«ã‚‚è§£èª¬ã—ã¦ããŸé€šã‚Šã€LLMã«ã¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé™ç•Œã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚é–¢é€£ã™ã‚‹æƒ…å ±ã‚’äº‹å‰ã«å…¨ã¦å…¥åŠ›ã—ã¦ã‹ã‚‰å›ç­”ã‚’å‡ºåŠ›ã™ã‚‹ã®ã¯å›°é›£ã§ã™ã€‚ãã“ã§è³ªå•æ–‡ã‹ã‚‰æ„å‘³ã®è¿‘ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã—ã¦ã€å¿…è¦ãªçŸ¥è­˜ã‚’æ‹¡å……ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ä¸Šã’ã¦å›ç­”ã•ã›ã‚‹ã€ã¨ã„ã†ä¸€é€£ã®å‡¦ç†ãŒRAGã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚æ¤œç´¢ã®æ‰‹æ³•ã«ã¯æ§˜ã€…ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ãŒã€ãã“ã§Embeddingã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ãŒå¤šãã€æœ€çµ‚çš„ã«ã€Œãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ã‚’æ‹¡å……ã•ã›ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆã¨ãªã‚Šã¾ã™ã€‚

RAGã¯ä¸€æ™‚æœŸã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé™ç•Œã®å•é¡Œã‚’ä¸€æŒ™ã«è§£æ±ºã™ã‚‹æŠ€è¡“ã®ã‚ˆã†ã«ã‚‚ã¦ã¯ã‚„ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—LLMã®åˆ©ç”¨ç¯„å›²ãŒã•ã‚‰ã«æ‹¡å¤§ã—ãŸçµæœã€å®Ÿéš›ã«ã¯è§£æ±ºã§ãã‚‹å•é¡Œã¯é™ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ãã¾ã—ãŸã€‚å‡ºåŠ›ã™ã¹ãå†…å®¹ãŒãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã¨ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«çµã³ã¤ãçŸ¥è­˜ã‚„äº‹å®Ÿæƒ…å ±ãªã©ã§ã‚ã‚Œã°æœ‰ç”¨ã§ã™ã€‚ã“ã‚Œã¯ä¸€å•ä¸€ç­”å½¢å¼ã®LLMãƒãƒ£ãƒƒãƒˆã§ã¯ç‰¹ã«æœ‰åŠ¹ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ãã®ã¾ã¾å›ç­”ã™ã‚‹ç³»ã®ã‚¿ã‚¹ã‚¯ã«ã¯é©ã—ã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ç¾åœ¨ã®LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚ˆã†ã«è¤‡é›‘ãªã‚¿ã‚¹ã‚¯ã®å‡¦ç†ã«ãŠã„ã¦å¿…ãšã—ã‚‚æ´»ç”¨ã§ãã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚ãŸã¨ãˆã°ä»Šå›ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§ã‚‚ã€ãƒ­ã‚°ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’APIãªã©ã‚’çµŒç”±ã—ã¦å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã«å¯¾ã—ã¦çŸ¥è­˜ã‚„äº‹å®Ÿæƒ…å ±ã‚’è£œå®Œã™ã‚‹ã“ã¨ãŒæœ‰ç”¨ã§ã¯ãªã„ã‚±ãƒ¼ã‚¹ã‚‚å¤šãã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€RAGãã®ã‚‚ã®ã«ã¤ã„ã¦ã¯LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç›®çš„ã«å¿œã˜ã¦ä½¿ã£ãŸã‚Šä½¿ã‚ãªã‹ã£ãŸã‚Šã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§ã¯å¾“æ¥ã®RAGã¯ã‚ã¾ã‚Šããã‚ãªã„ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã‹ã‚‰æ±²ã¿å–ã‚Œã‚‹è£œå®Œæƒ…å ±ãŒã‚ã¾ã‚Šãªã„ãŸã‚ã§ã™ã€‚ã—ã‹ã—Embeddingã®æŠ€è¡“è‡ªä½“ã¯æ´»ç”¨ã®ã—ãŒã„ãŒã‚ã‚‹ãŸã‚ã€ãã‚Œã¯æœ‰åŠ¹æ´»ç”¨ã—ã¦ã„ãã¾ã™ã€‚

```mermaid
flowchart TB
    User((ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼))

    subgraph preparation[ğŸ“š æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º]
        direction TB
        Docs[ğŸ“„ ç¤¾å†…æ–‡æ›¸ãƒ»ãƒ‡ãƒ¼ã‚¿]
        Docs -->|Embedding| VectorDB[(ğŸ—„ï¸ ãƒ™ã‚¯ãƒˆãƒ«DB)]
        Note1[ğŸ’¡ äº‹å‰ã«ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã¦<br/>ä¿å­˜ã—ã¦ãŠã] -.-> VectorDB
    end

    subgraph search[ğŸ” æ¤œç´¢ãƒ»å›ç­”ãƒ•ã‚§ãƒ¼ã‚º]
        direction TB
        App[ğŸ’» ã‚¢ãƒ—ãƒª/ã‚·ã‚¹ãƒ†ãƒ ]
        App -->|è³ªå•ã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–| Search[ğŸ” é¡ä¼¼æƒ…å ±ã®æ¤œç´¢]
        Search -->|é–¢ä¿‚ã‚ã‚Šãã†ãª<br/>æƒ…å ±ã‚’å–å¾—| Prompt[ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ]
        Prompt -->|å‘½ä»¤ + æ¤œç´¢ã—ãŸæƒ…å ±| LLM[ğŸ¤– ç”ŸæˆAI]
    end

    User -->|è³ªå•| App
    LLM -->|å›ç­”| User
    VectorDB -.->|é¡ä¼¼åº¦æ¤œç´¢| Search

    style VectorDB fill:#f9f,stroke:#333,stroke-width:2px
    style LLM fill:#bbf,stroke:#333,stroke-width:2px
```

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã«ãŠã‘ã‚‹Embeddingã®åˆ©æ´»ç”¨

## ã„ã‚ã‚†ã‚‹RAGã¨ã—ã¦ã®æ´»ç”¨ã¯é›£ã—ã„

å…ˆè¿°ã—ãŸé€šã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒå…¥åŠ›ã—ãŸå†…å®¹ã«å¯¾ã™ã‚‹RAGã¯åŠ¹æœãŒè–„ã„ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦æ‹¡å……ã™ã‚‹çŸ¥è­˜ã¨ã„ã†ã‚‚ã®ãŒã‚ã¾ã‚Šãªã„ãŸã‚ã§ã™ã€‚

ãŸã¨ãˆã°çµ„ç¹”å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©ã‚’å¤§é‡ã«äº‹å‰ã«ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã™ã‚‹ã¨ã„ã†ã‚ˆã†ãªåˆ©ç”¨æ–¹æ³•ã¯ã‚ã¾ã‚Šæ€ã„ã¤ãã¾ã›ã‚“ã€‚çµ„ç¹”ãƒãƒªã‚·ãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ç’°å¢ƒã®æƒ…å ±ãªã©ã‚’ç‹¬è‡ªã«å…¥åŠ›ã™ã‚‹ã¨ã„ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯è€ƒãˆã‚‰ã‚Œã¾ã™ãŒã€ãã‚Œã‚‚ãã‚Œã»ã©å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ã¨ã¯è€ƒãˆã«ãã„çŠ¶æ³ã§ã™ã€‚ãƒãƒªã‚·ãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢ã™ã‚‹çŸ¥è­˜ã§ã‚ã‚Œã°ã€äº‹å‰ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å…¥ã‚Œã¦ãŠã‘ã°ååˆ†ãªç¯„å›²ã ã£ãŸã‚Šã‚‚ã—ã¾ã™ã€‚

ã‚‚ã—å¤§é‡ã®ãƒãƒªã‚·ãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢ã™ã‚‹çŸ¥è­˜ãŒã‚ã‚Šã€ãã‚Œã‚’é©å®œä¸ãˆãŸã„ã¨ã„ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ãŸã ã—ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã‹ã‚‰é©åˆ‡ãªæƒ…å ±ã‚’å°å‡ºã™ã‚‹ã®ã¯é›£æ˜“åº¦ãŒé«˜ãã€ã©ã¡ã‚‰ã‹ã¨ã„ã†ã¨ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã™ã‚‹æ–¹ãŒç¾å®Ÿçš„ã§ã™ã€‚ã—ã‹ã—ã“ã‚Œã¯Embeddingã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸæ¤œç´¢ã§ã‚ã‚‹å¿…è¦æ€§ã¯ç‰¹ã«ãªãã€ãŸã¨ãˆã°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†SaaSã®æ¤œç´¢æ©Ÿèƒ½ã‚’ä½¿ãˆã°ååˆ†ã§ã™ã€‚ãŸã ã—æ—¢å­˜ã®æ¤œç´¢æ©Ÿèƒ½ãŒä¸ååˆ†ãªå ´åˆã¯ã€ä»£æ›¿ã®æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã‚’ç”¨æ„ã™ã‚‹éç¨‹ã§Embeddingã‚’æ´»ç”¨ã™ã‚‹ã®ã¯æœ‰åŠ¹ãªé¸æŠè‚¢ã¨ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§ã¯ã€Œæ„å‘³çš„ãªè¿‘ã•ã€ãŒä½¿ã‚ã‚Œãªã„ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’å¤šãå–ã‚Šæ‰±ã„ã¾ã™ã€‚ä»£è¡¨çš„ãªã®ãŒIoCï¼ˆIndicator of Compromiseï¼šä¾µå®³æŒ‡æ¨™ï¼‰ã«é–¢é€£ã™ã‚‹Indicatorã§ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ›ã‚¹ãƒˆåã€ãƒãƒƒã‚·ãƒ¥å€¤ãªã©ãŒè©²å½“ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯1æ–‡å­—é•ã£ãŸã ã‘ã§ã¾ã£ãŸãç•°ãªã‚‹æ„å‘³ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã€æ›–æ˜§ãªæ¤œç´¢ã«ã¯ä¸å‘ãã§ã™ã€‚

ã“ã‚Œã‚‰ã®ç†ç”±ã‹ã‚‰ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã®ãŸã‚ã«ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã«Embeddingã‚’åˆ©ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯ç­†è€…ã®çµŒé¨“ä¸Šã»ã¨ã‚“ã©ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã—æœ‰åŠ¹ãªæ´»ç”¨æ–¹æ³•ãŒã‚ã‚Œã°ãœã²æ•™ãˆã¦ãã ã•ã„ã€‚

## é¡ä¼¼æƒ…å ±ã®æ¤œç´¢æ©Ÿèƒ½ã¨ã—ã¦ã¯æœ‰ç”¨

ä¸€æ–¹ã§ã€Embeddingã‚’ä½¿ã£ãŸé¡ä¼¼æ¤œç´¢è‡ªä½“ã¯ã‹ãªã‚Šæœ‰ç”¨æ€§ã®å¹…ãŒåºƒã„ã¨è¨€ãˆã¾ã™ã€‚ä¸»ãªç”¨é€”ã¨ã—ã¦ã€é¡ä¼¼ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã®æ¤œç´¢ãªã©éå»äº‹ä¾‹æ¤œç´¢ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆã¯æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã§ã™ãŒã€JSONã«å¤‰æ›ã—ãŸã‚‚ã®ã¯æ™®é€šã«Embeddingã§ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãŸã¨ãˆã°ã€Œæ™‚åˆ»ã‚„IPã‚¢ãƒ‰ãƒ¬ã‚¹ãªã©ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå°‘ã—ã‚ºãƒ¬ã¦ã„ã‚‹ãŒæ¦‚ã­ä¼¼ãŸã‚ˆã†ãªã‚¢ãƒ©ãƒ¼ãƒˆã€ã¨ã„ã†ã‚‚ã®ã‚’æ‰‹è»½ã«æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹1: ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æ©Ÿèƒ½æä¾›ã—ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æ¤œç´¢ã•ã›ã‚‹

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¿…è¦ã«å¿œã˜ã¦é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã“ã¨ã§ã€ãŸã¨ãˆã°ãã®ã‚¢ãƒ©ãƒ¼ãƒˆã«ã¤ã„ã¦ã®å½±éŸ¿ã‚’åˆ†æã™ã‚‹ã¨ã„ã£ãŸã¨ãã€éå»ã«ç™ºç”Ÿã—ãŸä¼¼ãŸã‚ˆã†ãªã‚¢ãƒ©ãƒ¼ãƒˆãŒã©ã®ã‚ˆã†ã«å‡¦ç†ã•ã‚ŒãŸã‹ã‚’å®¹æ˜“ã«ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã‚‚ã¡ã‚ã‚“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¡ä»¶ã¨ã—ã¦æ¤œç´¢ã•ã›ã‚‹ã¨ã„ã†æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯å®Ÿè£…ãŒçµæ§‹é¢å€’ã§ã™ã€‚ãŸã¨ãˆã°ãƒ­ã‚°æ¤œç´¢ã¨åŒæ§˜ã«ã€ã‚¹ã‚­ãƒ¼ãƒã‚„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ¡ã‚¿æƒ…å ±ã€ã‚µãƒ³ãƒ—ãƒ«å€¤ãªã©ã‚’ã¡ã‚ƒã‚“ã¨ä¼ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã”ãä¸€éƒ¨ã ã‘ä¸€è‡´ã—ã¦ã„ã‚‹ãŒä»–ã¯å…¨ç„¶é•ã†ã¿ãŸã„ãªã‚‚ã®ã‚’å¼•ã£å¼µã£ã¦ãã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“æ„å›³ã—ã¦ã“ã®ã‚ˆã†ãªå³å¯†ãªæ¤œç´¢ã‚’è¨­ç½®ã—ã¦ãŠãã®ã‚‚æœ‰ç”¨ã§ã¯ã‚ã‚Šã¾ã™ã€‚

ã—ã‹ã—ã€Œä¼¼ãŸã‚ˆã†ãªã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã§ãã‚‹ã€ã¨ã„ã†æ©Ÿèƒ½ã‚’ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æä¾›ã—ã¦ãŠãã¨ã€å®Ÿè£…ã®æ‰‹é–“ã«å¯¾ã—ã¦å¾—ã‚‰ã‚Œã‚‹ä¾¡å€¤ãŒå¤§ãããªã‚Šã¾ã™ã€‚æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ã€éå»ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã‚‹ç¨‹åº¦ã¡ã‚ƒã‚“ã¨å‡¦ç†ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚é›‘ã«æ‰±ã‚ã‚Œã¦ã„ã‚‹ã¨ãã‚Œã‚’è¦‹ã¤ã‘ãŸã¨ã“ã‚ã§å¾—ã‚‰ã‚Œã‚‹æƒ…å ±ã¯å°‘ãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆã‚’Closeã™ã‚‹ã¨ããªã©ã«ç†ç”±ã‚’è¨˜è¼‰ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨ã€ãã®æƒ…å ±ã‚’æœ‰åŠ¹æ´»ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹2: é¡ä¼¼ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä¸€æ‹¬ã§å‡¦ç†ã™ã‚‹ã€ã‚ã‚‹ã„ã¯çµ±åˆã™ã‚‹

å®Ÿã¯ã“ã¡ã‚‰ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ã»ã†ãŒå®Ÿé‹ç”¨ã§ã¯éå¸¸ã«å¼·åŠ›ã§ã™ã€‚

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆç›£è¦–ã§ã¯ã‚ˆãã‚ã‚‹è©±ã¨ã—ã¦ã€æ¤œçŸ¥è¨­å®šãŒé–“é•ã£ã¦ã„ã¦ã‚¢ãƒ©ãƒ¼ãƒˆãŒæš´ç™ºã™ã‚‹ã€ãŸã¾ãŸã¾ãªã‚“ã‚‰ã‹ã®æ”»æ’ƒã«ã•ã‚‰ã•ã‚Œã¦ã‚¢ãƒ©ãƒ¼ãƒˆãŒå¤§é‡ç™ºç”Ÿã™ã‚‹ã€æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ å´ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒå¤‰æ›´ã•ã‚ŒãŸå½±éŸ¿ã§ã‚¢ãƒ©ãƒ¼ãƒˆãŒæš´ç™ºã™ã‚‹ã€ã¨ã„ã£ãŸäº‹è±¡ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã“ã†ã—ãŸãªã‚“ã‚‰ã‹ã®è¦å› ã§å¤§é‡ç™ºç”Ÿã—ãŸï¼ˆå½±éŸ¿ãŒãªã„ã¨ç¢ºä¿¡ã§ãã‚‹ï¼‰ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å…¨éƒ¨å‡¦ç†ã—ãªã„ã¨ã„ã‘ãªã„ã¨ã„ã†çŠ¶æ³ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚

ã²ã©ã„ã¨ãã¯æ•°åƒä»¶ã¨ã‹ã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’1ä»¶ãšã¤ç¢ºèªã—ã¦ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚‹ã®ã¯è‹¦ç—›ã§ã™ã€‚ã—ã‹ã—ã¾ã¨ã‚ã¦ã‚¯ãƒ­ãƒ¼ã‚ºã§ãã‚‹ã‹ã¨ã„ã†ã¨ãã‚Œã‚‚é›£ã—ã„ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã—ã‚Œã£ã¨1ä»¶å…¨ç„¶é–¢ä¿‚ãªã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ··ã–ã£ã¦ã„ãªã„ã‹å¿ƒé…ã«ãªã‚Šã¾ã™ã€‚ä¼¼ãŸã‚ˆã†ãªã‚¢ãƒ©ãƒ¼ãƒˆã§ã‚ã‚Œã°å¤§ä¸ˆå¤«ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ãŒã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã™ã‚Œã°ã„ã„ã‹ã¨æ€ã„ãã‚„ã€åŒã˜ç¨®é¡ã®ã‚¢ãƒ©ãƒ¼ãƒˆã ãŒã¾ã£ãŸãé•ã†ã‚‚ã®ãŒæ··ã–ã£ã¦ã„ã‚‹ã€ã¨ã„ã†ã®ã‚‚ã‚ã‚Šãˆã¾ã™ã€‚ã“ã†ã—ãŸå‡¦ç†ãŒé¢å€’ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãŒæ»ã‚‹ã¨ã„ã†ã®ã‚‚çã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ç­†è€…ã‚‚ã‚ˆãçµŒé¨“ã—ã¦ã„ã¾ã—ãŸã€‚

ã¨ã„ã†ã“ã¨ã§ã“ã‚Œã‚’Embeddingã‚’ä½¿ã£ã¦è§£æ±ºã—ã¾ã™ã€‚ä¸€æ‹¬ã‚¯ãƒ­ãƒ¼ã‚ºå¯¾è±¡ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ¤œç´¢ã§ãã¾ã™ã€‚

ã¾ãšã€ã‚¢ãƒ©ãƒ¼ãƒˆã®é¡ä¼¼åº¦ï¼ˆã‚³ã‚µã‚¤ãƒ³è·é›¢ï¼‰ã¯0ã€œ2ã§è¡¨ç¾ã•ã‚Œã¾ã™ï¼ˆ0ã»ã©è¿‘ã„ï¼‰ã€‚ã—ãã„å€¤ã‚’è¨­ã‘ã¦é¡ä¼¼åº¦ã§è¶³åˆ‡ã‚Šã—ã¾ã™ã€‚ãŸã¨ãˆã°0.1ä»¥ä¸‹ã¨ã™ã‚‹ã¨ã‹ãªã‚Šè¿‘ã—ã„ã‚¢ãƒ©ãƒ¼ãƒˆã«ãªã‚Šã¾ã™ã€‚ãã“ã‹ã‚‰ã•ã‚‰ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‹ã‘ã¾ã™ã€‚ã“ã‚Œã¯ã€Œä¼¼ã¦ã¯ã„ã‚‹ãŒã€æ„å›³ã—ã¦ã„ãªã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒç´›ã‚Œã¦ã„ãªã„ã‹ã€ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã§ã™ã€‚ã‚‚ã¡ã‚ã‚“ãã‚Œã§ã‚‚ç´›ã‚Œè¾¼ã‚€å¯èƒ½æ€§ã¯0ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ãã“ã¾ã§å¿ƒé…ãªã‚‰ç›®è¦–ã§ç¢ºèªã™ã‚‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

ã“ã†ã™ã‚‹ã“ã¨ã§ã€æ¦‚ã­æ„å›³ã—ãŸé–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ã¨ã„ã†ã‚‚ã®ãŒæ‹¾ãˆã¾ã™ã€‚ã“ã‚Œã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚‹ãªã‚Šã€åˆ¥ã®ã‚‚ã®ã«ãƒãƒ¼ã‚¸ã™ã‚‹ãªã‚Šã™ã‚Œã°ã‚·ã‚¹ãƒ†ãƒ ä¸Šã¾ã¨ã‚ã¦å‡¦ç†ã§ãã¾ã™ã€‚ã“ã‚Œã¯ä½œæ¥­æ™‚é–“çš„ã«ã‚‚ç²¾ç¥çš„è² æ‹…ã‹ã‚‰ã‚‚ã‹ãªã‚Šå¤§ããªåŠ¹ç‡åŒ–ã«ãªã‚Šã¾ã™ã€‚

# Embeddingã®å®Ÿè£…

ä»Šå›ã¯ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹2ã®é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã™ã‚‹ã¨ã“ã‚ã¾ã§å®Ÿè£…ã—ã¾ã™ã€‚ãã®ã‚ã¨ã‚¯ãƒ­ãƒ¼ã‚ºã—ãŸã‚Šãƒãƒ¼ã‚¸ã—ãŸã‚Šã¨ã„ã£ãŸå‡¦ç†ã¯ã€èª­è€…ãŒè‡ªç”±ã«å®Ÿè£…ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æ¤œç´¢æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹å ´åˆã‚‚åŸºæœ¬çš„ã«ã¯åŒã˜å®Ÿè£…ã«ãªã‚‹ãŸã‚ã€ä»Šå›ã¯èª¬æ˜ã‚’å‰²æ„›ã—ã¾ã™ã€‚

## Firestoreã®indexä½œæˆ

ã¾ãšFirestoreã§ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚’ä½¿ã†å ´åˆã€Indexã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚ãªãŠã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¨ãƒ™ã‚¯ãƒˆãƒ«ã®æ¬¡å…ƒæ•°ã¯ã“ã®æ™‚ç‚¹ã§æ±ºå®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸé‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã€ãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„ã€ã‚ã‚‹ã„ã¯0ãƒ™ã‚¯ãƒˆãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã¨ã€Firestoreã§ã¯æ¤œç´¢ã«å¤±æ•—ã™ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ãã®ãŸã‚Embeddingã‚’ä½¿ã†ã®ã§ã‚ã‚Œã°ã€å…¨ãæ–°ã—ã„collectionã‚’ä½¿ã†ã‹ã€collectionã®æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®Embeddingã‚’ã‚ã¨åŸ‹ã‚ã™ã‚‹ã‹ã€ã„ãšã‚Œã‹ã®å¯¾å¿œãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

```bash
gcloud firestore indexes composite create --project=your-project --database=your-database --collection-group=alerts --query-scope=COLLECTION --field-config=vector-config='{"dimension":"768","flat": "{}"}',field-path=Embedding
```

## Embeddingã®ç”Ÿæˆ

Embeddingã®ç”Ÿæˆã¯éå¸¸ã«ç°¡å˜ã§ã™ã€‚Geminiã®å ´åˆã¯ `EmbedContent` ã‚’å‘¼ã³å‡ºã™ã ã‘ã§å®Œäº†ã—ã¾ã™ã€‚æ³¨æ„ã™ã¹ããƒã‚¤ãƒ³ãƒˆã¯æ¬¡å…ƒæ•°ã®è¨­å®šã§ã™ã€‚ã“ã‚Œã¯Firestoreå´ã§è¨­å®šã—ãŸæ¬¡å…ƒæ•°ã«åˆã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡å…ƒæ•°ãŒå¤šã‘ã‚Œã°å¤šã„ã»ã©ã‚ˆã‚Šç²¾ç·»ã«è¡¨ç¾ã§ãã¾ã™ãŒã€ä½“æ„Ÿçš„ã«ã¯500ç¨‹åº¦ã‚ã‚Œã°ååˆ†ã§ã™ã€‚ä»Šå›ã¯768æ¬¡å…ƒã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```go:pkg/adapter/gemini.go
func (g *GeminiClient) Embedding(ctx context.Context, text string, dimensions int) (firestore.Vector32, error) {
	config := &genai.EmbedContentConfig{}
	if dimensions > 0 {
		d := int32(dimensions)
		config.OutputDimensionality = &d
	}

	resp, err := g.client.Models.EmbedContent(ctx, g.embeddingModel, genai.Text(text), config)
	if err != nil {
		return nil, goerr.Wrap(err, "failed to embed content")
	}

	if len(resp.Embeddings) == 0 {
		return nil, goerr.New("no embeddings returned")
	}

	return firestore.Vector32(resp.Embeddings[0].Values), nil
}
```

## Alertã¸ã®åŸ‹ã‚è¾¼ã¿

æ¬¡ã«ã€ã‚¢ãƒ©ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã«Embeddingã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã€`PutAlert` ã™ã‚‹ç›´å‰ã«Embeddingã‚’ç”Ÿæˆã—ã¦æ ¼ç´ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

```go
	// Generate embedding vector from original alert data
	embedding, err := u.gemini.Embedding(ctx, string(jsonData), 768)
	if err != nil {
		return nil, goerr.Wrap(err, "failed to generate embedding")
	}
	alert.Embedding = embedding

	if err := u.repo.PutAlert(ctx, alert); err != nil {
		return nil, err
	}
```

Goå®Ÿè£…ã«ãŠã‘ã‚‹ãƒã‚¤ãƒ³ãƒˆã¯ã€`firestore.Vector32` ã‚ã‚‹ã„ã¯ `Vector64` ã‚’ä½¿ã†ã“ã¨ã§ã™ã€‚ã“ã‚Œã‚’ä½¿ã‚ãªã„ã¨ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦æ­£ã—ãèªè­˜ã•ã‚Œã¾ã›ã‚“ã€‚

```go
type Alert struct {
	ID          AlertID
	Title       string
	Description string
	Data        any
	Attributes  []*Attribute
	Embedding   firestore.Vector32
```

## Alertã®æ¤œç´¢

æ¬¡ã«ã€é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã™ã‚‹å®Ÿè£…ã§ã™ã€‚Firestoreã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```go:pkg/repository/firestore.go
func (r *Firestore) SearchSimilarAlerts(ctx context.Context, embedding []float64, threshold float64) ([]*model.Alert, error) {
	client, err := r.getClient(ctx)
	if err != nil {
		return nil, err
	}

	// Convert []float64 to firestore.Vector32
	vector32 := make(firestore.Vector32, len(embedding))
	for i, v := range embedding {
		vector32[i] = float32(v)
	}

	// Build vector query with distance threshold
	query := client.Collection(alertCollection).
		FindNearest("Embedding", vector32, 1000, firestore.DistanceMeasureCosine, &firestore.FindNearestOptions{
			DistanceThreshold: &threshold,
		})

	// Execute query
	iter := query.Documents(ctx)
	defer iter.Stop()
```

ã“ã“ã§ã¯ `FindNearest` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ãƒ™ã‚¯ãƒˆãƒ«ã®è·é›¢ã®è¨ˆç®—ã«ã¯ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ã€ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã€ãƒ‰ãƒƒãƒˆç©ãŒé¸æŠã§ãã¾ã™ãŒã€Embeddingã®é¡ä¼¼åº¦ã‚’æ¸¬ã‚‹ã«ã¯ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã‚’ä½¿ã†ã®ãŒè‰¯ã„ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ã—ã„ç†è«–çš„èƒŒæ™¯ã«ã¤ã„ã¦ã¯é–¢å¿ƒãŒã‚ã‚‹æ–¹ã¯èª¿ã¹ã¦ã¿ã¦ãã ã•ã„ã€‚

## CLIã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…

æ¬¡ã«ã€`similar` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè£…ã—ã¦é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚æŒ‡å®šã•ã‚ŒãŸIDã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å–å¾—ã—ã€ãã®Embeddingã®å€¤ã‚’ä½¿ã£ã¦é¡ä¼¼ã™ã‚‹ã‚‚ã®ã‚’æ¤œç´¢ã—ã¾ã™ã€‚å–å¾—ã—ãŸçµæœã‹ã‚‰ã•ã‚‰ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹ã“ã¨ã§ã€æ„å›³ã—ãªã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ··å…¥ã™ã‚‹ã®ã‚’é˜²ãã¾ã™ã€‚

```go:pkg/cli/similar.go
// Get the source alert
sourceAlert, err := repo.GetAlert(ctx, model.AlertID(alertID))
if err != nil {
    return goerr.Wrap(err, "failed to get source alert")
}

if len(sourceAlert.Embedding) == 0 {
    return goerr.New("source alert does not have an embedding vector")
}

// Search for similar alerts with threshold
similarAlerts, err := repo.SearchSimilarAlerts(ctx, sourceAlert.Embedding, threshold)
if err != nil {
    return goerr.Wrap(err, "failed to search similar alerts")
}

// Filter alerts
var filtered []*model.Alert

for _, alert := range similarAlerts {
    // Skip the source alert itself
    if alert.ID == sourceAlert.ID {
        continue
    }

    // Apply keyword filters (AND condition) on alert data
    if len(filters) > 0 {
        // Marshal alert data to JSON for filtering
        dataJSON, err := json.Marshal(alert.Data)
        if err != nil {
            return goerr.Wrap(err, "failed to marshal alert data", goerr.Value("alert_id", alert.ID))
        }
        dataStr := string(dataJSON)

        allMatch := true
        for _, filter := range filters {
            if !strings.Contains(dataStr, filter) {
                allMatch = false
                break
            }
        }
        if !allMatch {
            continue
        }
    }

    filtered = append(filtered, alert)
}
```

## å®Ÿè¡Œä¾‹

ä»¥ä¸‹ã¯ã€ã‚ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆæš—å·é€šè²¨ãƒã‚¤ãƒ‹ãƒ³ã‚°æ¤œå‡ºï¼‰ã«å¯¾ã—ã¦é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã—ãŸå®Ÿè¡Œä¾‹ã§ã™ã€‚

### é–¾å€¤0.1ã®å ´åˆ

```bash
$ go run . similar -i 69a6df97-b36f-49d4-87bb-3643246b4a4c -t 0.1
Found 2 similar alerts for 69a6df97-b36f-49d4-87bb-3643246b4a4c (Cryptocurrency Miner (XMRig) Detected on 'web-server-prod-01' due to CVE-2023-32784):

1. 8344452d-bdb9-4e64-9121-b1b2b0d14744 (distance: 0.0000)
   Title: Cryptominer (XMRig) Detected on Instance 'web-server-prod-01'
   Description: A cryptocurrency mining software (XMRig) has been detected running on Compute Engine instance 'web-server-prod-01'. This instance is connecting to known Monero mining pools and consuming significant CPU resources, indicating a potential compromise via CVE-2023-32784 from an attacker in Romania. Immediate investigation and remediation are required to prevent further resource abuse and potential data exposure.

2. a859cb2f-9392-4ceb-9420-c554f9b63766 (distance: 0.0120)
   Title: Cryptocurrency Mining Detected on Compute Engine Instance
   Description: Cryptocurrency mining software (XMRig) has been detected running on the 'web-server-prod-01' instance, consuming 98.5% CPU resources. The instance is connecting to a known Monero mining pool, indicating a potential compromise and resource abuse.
```

é–¾å€¤ã‚’0.1ã«è¨­å®šã—ãŸå ´åˆã€2ä»¶ã®é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚1ä»¶ç›®ï¼ˆ`examples/alert/scc.json`ï¼‰ã¯distanceãŒ0.0000ã§ã»ã¼åŒä¸€ã®å†…å®¹ã€2ä»¶ç›®ï¼ˆ`examples/alert/scc_mini.json`ï¼‰ã¯distanceãŒ0.0120ã§éå¸¸ã«é¡ä¼¼ã—ãŸå†…å®¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚

### é–¾å€¤0.01ã®å ´åˆ

```bash
$ go run . similar -i 69a6df97-b36f-49d4-87bb-3643246b4a4c -t 0.01
Found 1 similar alerts for 69a6df97-b36f-49d4-87bb-3643246b4a4c (Cryptocurrency Miner (XMRig) Detected on 'web-server-prod-01' due to CVE-2023-32784):

1. 8344452d-bdb9-4e64-9121-b1b2b0d14744 (distance: 0.0000)
   Title: Cryptominer (XMRig) Detected on Instance 'web-server-prod-01'
   Description: A cryptocurrency mining software (XMRig) has been detected running on Compute Engine instance 'web-server-prod-01'. This instance is connecting to known Monero mining pools and consuming significant CPU resources, indicating a potential compromise via CVE-2023-32784 from an attacker in Romania. Immediate investigation and remediation are required to prevent further resource abuse and potential data exposure.
```

é–¾å€¤ã‚’0.01ã«ä¸‹ã’ã‚‹ã¨ã€ã‚ˆã‚Šå³å¯†ãªé¡ä¼¼åº¦åˆ¤å®šã¨ãªã‚Šã€ã»ã¼åŒä¸€ã®å†…å®¹ã®ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ`examples/alert/scc.json`ï¼‰ã®ã¿ãŒæŠ½å‡ºã•ã‚Œã¾ã—ãŸã€‚ã“ã®ã‚ˆã†ã«é–¾å€¤ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã§ã€æ¤œç´¢ã®ç²¾åº¦ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ã€‚

# ã¾ã¨ã‚

æœ¬æ—¥ã¯Embeddingã«ã‚ˆã‚‹é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œç´¢æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¯2ã¤ã§ã™ã€‚

1ã¤ç›®ã¯ã€Embeddingã¯RAGã®ä¸€éƒ¨ã§ã‚ã‚Šã€RAGãªã—ã§ã‚‚æ´»ç”¨ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚RAGãŒæ³¨ç›®ã•ã‚ŒãŒã¡ã§ã™ãŒã€Embeddingã ã‘ã‚’åˆ©ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚‚å¤šãå­˜åœ¨ã—ã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã¯ãã®ä»£è¡¨ä¾‹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã«å¯¾ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ‹¡å……ã™ã¹ãçŸ¥è­˜ãŒæ˜ç¢ºã«å­˜åœ¨ã—ãªã„ãŸã‚ã€RAGã¨ã—ã¦ã¯åŠ¹æœãŒé™å®šçš„ã§ã™ã€‚ã—ã‹ã—Embeddingã‚’ä½¿ã£ãŸé¡ä¼¼æ¤œç´¢ã¯å¼·åŠ›ã§ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®ã‚ˆã†ã«ã‚¹ã‚­ãƒ¼ãƒãŒå¤šæ§˜ãªæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¡ä¼¼äº‹ä¾‹ã‚’æ¢ã™å ´åˆã€å¾“æ¥ã®æ¤œç´¢ã§ã¯å®Ÿç¾å›°é›£ã ã£ãŸæŸ”è»Ÿæ€§ã‚’æä¾›ã—ã¾ã™ã€‚

2ã¤ç›®ã¯ã€Embeddingã«ã‚ˆã‚‹æ¤œç´¢çµæœã‚’ãã®ã¾ã¾ä½¿ã†ã®ã§ã¯ãªãã€å·¥å¤«ãŒå¿…è¦ã ã¨ã„ã†ã“ã¨ã§ã™ã€‚ä»Šå›å®Ÿè£…ã—ãŸã‚ˆã†ã«ã€é¡ä¼¼åº¦ã®ã—ãã„å€¤ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€å®‰å…¨æ€§ã¨åŠ¹ç‡æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¾ã™ã€‚ã—ãã„å€¤ã ã‘ã§ã¯æ„å›³ã—ãªã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ··å…¥ã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã ã‘ã§ã¯æŸ”è»Ÿæ€§ã«æ¬ ã‘ã¾ã™ã€‚ã“ã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚Šã€ã‚¢ãƒ©ãƒ¼ãƒˆæš´ç™ºæ™‚ã«æ•°åƒä»¶ã‚’ç›®è¦–ç¢ºèªã™ã‚‹å¿…è¦ãŒãªããªã‚Šã€é«˜ã„ç¢ºåº¦ã§é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿ã‚’æŠ½å‡ºã—ã¦ä¸€æ‹¬å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

Embeddingã¯é¡ä¼¼æ¤œç´¢ä»¥å¤–ã«ã‚‚ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã‚„ç•°å¸¸æ¤œçŸ¥ãªã©æ§˜ã€…ãªå¿œç”¨ãŒå¯èƒ½ã§ã™ã€‚è‡ªåˆ†ã®çµ„ç¹”ã‚„ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã€Œæ„å‘³çš„ã«ä¼¼ãŸã‚‚ã®ã‚’è¦‹ã¤ã‘ãŸã„ã€ã¨ã„ã†ãƒ‹ãƒ¼ã‚ºãŒã‚ã‚Œã°ã€ç©æ¥µçš„ã«æ´»ç”¨ã‚’æ¤œè¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
