---
title: "Goで作るセキュリティ分析LLMエージェント(24): アラート管理との統合とWeb・チャットインターフェース"
emoji: "🖥️"
type: "tech"
topics: ["ai", "go", "agent", "api"]
published: true
---

この記事はアドベントカレンダー「[Goで作るセキュリティ分析LLMエージェント](https://adventar.org/calendars/11354)」の24日目です。

本アドベントカレンダーでは、これまでセキュリティ分析LLMエージェントを開発のしやすさの観点から、CLI上で動作するように実装してきました。しかし実際のセキュリティ分析業務においては、CLIでは不便なことが多く、あまり実用的ではありません。とはいえ、これをオンラインシステムに組み込む実装について全て説明するのはあまりにも長くなるため、本アドベントカレンダーでは触れてきませんでした。

その代わり、今回の記事では[warren](https://github.com/secmon-lab/warren)について説明します。warrenは実際にLLMエージェントを組み込んだセキュリティアラートの管理および分析のオンラインシステムです。ここまで解説してきたLLMエージェントに関する実装の知識をベースに、オンラインシステムをどのように実装すると業務に活かせるかという観点を解説します。

# アラート管理とアラート分析システムの統合

まず、この2つを統合することに意味はあるのかについて整理します。アラート分析とは、これまでの記事で解説してきたように、アラートに関連する情報を各所から集めて必要に応じて深掘りし、最終的に集めた情報をもとにアラートによる影響を判断することです。一方、アラート管理とは、アラートとして発報されたものの対応状況を記録管理するものです。具体的には、ステータス（未対応、対応中、対応完了）、結論（誤検知、検知は正常だが影響なし、実際に影響が見られた）、エスカレーションの有無（インシデントレスポンスとして別システムで対応されたかなど）といった情報を管理します。なお、ここでは「アラート管理」を影響のあるインシデントかどうかの判断までとします。インシデント対応まで含めたアラート管理システムもありますが、インシデント管理システムは別立てしている場合も多いためです。

従来、これら2つの機能はそれぞれ別々で構築運用されていました。アラート管理はチケットシステムやSIEM上のアラート情報などで管理され、分析はSOAR（Security Orchestration Automation and Response）でのワークフローやSIEM（Security Information and Event Manager）上での検索などで実現されていました。従来の業務フローを考えると、それでも機能していました。分析はSOARで一部自動化されるものの、ほぼ必ず人間の手が介入するため、無理に統合する必要はなかったのです。人間が対応する部分は直接的にアラートと紐づけて記録されるものではありませんし、記録したところであまり活用の道筋もありませんでした。初心者が熟練者の作業記録を見て学ぶといったケースはありえますが、実地でそうした活用をするのは稀と考えられます。

しかしLLMエージェントを利用すると、状況が大きく変わってきます。まず、分析の過程が容易に記録でき、その記録を記憶システムなどで利活用できるようになります。アラート（あるいはアラートを管理するチケット）と密結合していることで、プロンプトエンジニアリングによる情報の注入が容易になります。さらにFunction Callingを使えば、アラートそのものへの操作として、アノテーションなどもエージェントにやらせることができます。対応する対象と対応状況の記録を密結合させることで、アラート発出後の対応の見通しもよくなります。

こうした観点から、AIエージェント活用の側面では管理および分析を統合する価値が高いといえます。なお、インシデント対応についても同じような価値を発揮できる可能性がありますが、筆者はそのようなインシデントに相まみえる機会が今のところ少ないため、ここでの言及は避けます。

# アラート管理・分析システムの要件

アラート管理・分析システムに求められる要件について簡単にまとめます。

## アラートの受信

アラート管理・分析システムは、自身でアラートを発見する機能は持ちません。そのため、外部のセキュリティ監視・防御システムや、SaaS（例えばGoogle Workspace）のセキュリティアラートを受け取る必要があります。受け取る方法は様々ですが、Webhook APIの口が用意されていればだいたいなんとかなります。SQSやPub/Subのリクエストを受け取れるようにしておくと、さらに融通がききます。こちらからAPIでpullしないといけないシステムについても、スクリプトなどで取得して流し込めば対応できます。

アラートを受信した際には、いろいろな処理をワークフローとして実行したいという要件があります。まずアラートは必ずしも処理しやすい形で投げ込まれるとは限りません。1メッセージに複数アラートが含まれる場合もあるため、変換などが必要になります（ingest）。さらに受信時に必要な情報を付与したり（enrich）、不要そうなら閉じるという対応（triage）も実行したいところです。これらをAPI経由でアラートを受けたときに、一連の動作として自動実行できるようにします。

## アラートの対応・分析

対応・分析は、なるべく使い慣れたツールで行いたいという要件があります。独自UIでもよいのですが、やはり使い慣れているものがやりやすいです。通知を受けたあとにいちいち別のシステムに遷移するのも面倒です。一方で、分析の過程や結果といった記録自体は、後から参照したり記憶システムで活用したりするために、システム内にちゃんと閉じ込めておきたいという点も重要になります。この「使い慣れたツールで作業できる」と「記録を適切に管理する」という2つの要件を両立させる必要があります。

また、関係者とコミュニケーションが取りやすい仕組みが望ましいです。アラート対応の業務では、体感で1/3〜1/2程度が「人に聞く」という作業になります。具体的には、false positiveの可能性を確認したり、正規の手続きで意図的にやったことなのか確認したり、影響の有無を判断するために状況や環境の情報を聞いたりといったことです。独自UIだと、そこに関係者を誘導しないといけません。関係者は当然ながらセキュリティに関係しない人を含むというか、むしろ99%がそちらです。そうするとその人達向けにもアカウントを用意したりといったことが発生して手間がかかります。物によってはライセンス数の問題もあります。さらに単純にコミュニケーションが途切れると面倒です。例えばSlack上で話していたことをもう一度転記したりするのは非効率的です。そのため、シームレスにコミュニケーションをとれる仕組みが望ましいといえます。

## アラートの管理

先述した通り、アラートがどういう状況かをちゃんと把握したいという要件があります。アラートそのものの状況（未対応、対応中、対応完了）や影響度の判断、誰が担当しているのか、対応でどのような過程を辿ったのかといった情報を記録すべきです。

ここで重要になるのが、似たようなアラートの処理です。Embeddingの回でも触れましたが、似たようなアラートが大量に出たときに、それを個別に対応しないといけないというのは非効率的です。こういったものを一括で処理できるようにしたいという要件があります。

# AIネイティブなアラート管理・分析システム：Warren

これまでに解説してきた要件を踏まえて、実際に実装したのがwarrenです。

https://github.com/secmon-lab/warren

## アラート受信

![](https://storage.googleapis.com/zenn-user-upload/bfd53171cff8-20251221.png)
_受信したアラートについてSlackへ通知が送信される_

warrenでは、一般的なWebhookやPub/Sub、SNSといったAPIに対応しています。ワークフローについては以前に解説したものとほぼ同様なので、ここでは省略します。

事前に定義したenrichおよびtriageのポリシーに基づいて、通知を抑制したり、そもそもアラートとして取り扱わない（無視）するといったことも可能です。例えばセキュリティ監視のアラートについては無視するのが怖いため、基本的には全て受け入れるようにします。一方でセキュリティ関連のニュース記事をアラートと見立てて処理することも可能です。RSSフィードを受信したらAPIへPostするスクリプトを別途用意し、プロンプトで自組織の状況、使っている技術スタックやツールなどの情報を与えておけば、全く関係ない記事は無視させるといったことができます。

セキュリティ監視のアラートについては、事前に調査するエージェントを実行しておくこともできます。ただしアラートが頻発したときに、外部APIをたたくレートリミットにヒットしないかだけ注意が必要です。

## アラート分析

![](https://storage.googleapis.com/zenn-user-upload/e8a73dcfbf47-20251221.png)
_Slackのスレッド内でエージェントと会話形式で指示が可能_

![](https://storage.googleapis.com/zenn-user-upload/8441b7562bb4-20251221.png)
_質問されたことに対して結論が得られたら報告してくれる_

分析については、まさにこれまで実装してきたLLMエージェントと同等の機能を提供しています。ボットをあらかじめ用意しておき、それに対してメンションすると必要な情報をかき集めてくれます。設定したツールに応じて計画を立てて実行してくれる（Plan&Execute）ため、図の例では脅威情報を集めているだけですが、ログ検索の実行もしてくれます（BigQueryツールとサブエージェント実装）。

エージェントの結論自体をそのまま採用する必要はありませんが、一般知識も交えた回答をしてくれます。より精度の高い回答をさせたい場合は、組織の状況をシステムプロンプトに組み込んでおくとよいでしょう（プロンプトエンジニアリング）。

## アラート管理

![](https://storage.googleapis.com/zenn-user-upload/5696d8e6495a-20251221.png)
_Webインターフェイスにおけるダッシュボード_

アラートの管理という側面ではWeb UIを活用したほうがよいでしょう。Slackはフロー的に情報を扱うのには適していますが、ストック的に扱うのは難しいためです。大量のアラートを処理したり、残アラートを確認したり、対応の記録を見たりするといった作業は、専用UIの方が自由度が高くなります。

従来であれば、ユーザインタフェースをSlackとWeb両方に持つというのはメンテコストが高くてアンチパターンでした。しかし生成AIコーディングの躍進により、現実的な工数で両方を維持することができるようになりました。インタラクティブなやり取りや、他の組織内メンバーとのやりとりなどはSlackに圧倒的な利がありますが、その他の操作はWeb UIを活用するのがよいでしょう。特殊な操作をするインターフェイスも、Web UIの自由度の高さに利点があります。

![](https://storage.googleapis.com/zenn-user-upload/8d2427a643d2-20251221.png)
_例としてアラートを事前に類似度でクラスタリングして、まとめて起票するといったインターフェイスも用意できる_

Warrenはアラートを「チケット」という単位で管理しています。チケットはあくまで対応の単位であり、1つ以上のアラートを紐づけることができます。同じ事象を指していると見られるアラートをまとめることで、効率的に対応を進めることができるわけです。個別のアラートを一つずつチケットに紐づけていく"Bind"という機能も用意していますが、似たようなアラートが大量に発生した場合は、一つずつ対応するのは非効率的です。

そこで、Embeddingを利用した類似度検索およびフィルタによって、類似アラートを一括で処理できる機能も実装しています（Embeddingの回で解説した手法です）。これにより、例えば同じ脆弱性に起因する複数のアラートや、同じ攻撃元からの一連のアクセスといったものを、まとめて一つのチケットとして対応することができます。

![](https://storage.googleapis.com/zenn-user-upload/6025c4cebc92-20251221.png)
_類似アラートの一括処理画面_

# Warrenの実運用に関する所感

warrenは実際に筆者の業務内でも利用しており、プロトタイプも含めた運用期間は約1年ほどとなりました[^1year]。その実運用での効果や課題について紹介します。

[^1year]: ただし1年前にはまだ実用的なLLMエージェントの構築は難しく、セキュリティ分析における生成AI活用の模索をしていた期間としています。

## 分析業務の省力化

筆者のようにある程度セキュリティ分析ができるメンバーであれば、分析業務の大幅な省力化になります。脅威情報を調べるといった作業も簡単ではありますが、一定の手間がかかります。特に効果が大きいのがログ検索です。

筆者の業務環境ではBigQueryに全てのログが入っていますが、スキーマが大きすぎて人間には覚えられません。そのためこれまでは、よく使うSQL文をrunbook（手順書）のような形であらかじめ用意し、人間がアラートに応じてパラメータや条件をちまちま編集して使っていました。これがLLMエージェントを導入することで、BigQueryのスキーマ情報とrunbook、分析目的をあたえるだけで、LLMが適切なSQLを自動生成して実行してくれるようになりました。作業が大幅に楽になっただけでなく、分析に際して「重い腰を上げる」といった心理的障壁が激減したのも大きな効果です。正直、一度このLLMエージェントでの分析に慣れてしまうと、人手だけでやる気にはなれません。

## 非専門メンバーの分析業務サポート

セキュリティ分析が専門ではないメンバーも、一定のサポートはしつつも分析業務ができるようになってきました。最終的な判断について助言したりといったことはありますが、あやしいものや判断に悩むものをエスカレーションしてもらうことでうまく機能しています。特にSlackやGitHubから社内活動の情報を拾ってきて、それが正規の動作かどうかを確認することもできるようになっており（それらのツールを用意しています）、かなり助けになっています。

## 今後の課題と展望

銀の弾丸のように見えるかもしれませんが、実際にはまだまだ改良の余地があります。ツールの充実度や実行計画を精錬させるなど、やることはたくさんあります。また新しい機能もいろいろ挑戦したいものがあります。LLM自体の進化も激しいため、それをキャッチアップしながらより便利なものを作っていきたいと考えています。

# まとめ

セキュリティ分析におけるLLMエージェントの価値は、アラート管理と分析を統合することで初めて最大化されます。従来は分離されていたこれらの機能ですが、統合によって分析過程の記録と再利用、プロンプトへの文脈注入、Function Callingによる自動操作といった、エージェントならではの能力が発揮できるようになります。この統合は単に機能の合体ではなく、SlackとWeb UIといった複数インターフェースの開発・維持が現実的になったことも大きな意味を持ちます。これは単なる技術的な選択肢ではなく、適材適所でユーザインタフェースを用意するという、これまで両立が難しかった要件を実現する鍵となります。

本アドベントカレンダーで構築してきた個々の技術要素は、このような実業務への統合を経て初めて真価を発揮します。技術実装だけでなく、業務フローとユーザー体験の設計も含めて検討することが、実用的なシステム構築には不可欠ということが伝われば幸いです。

