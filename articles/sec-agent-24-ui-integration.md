---
title: "Goで作るセキュリティ分析LLMエージェント(24): アラート管理との統合とWeb・チャットインターフェース"
emoji: "🖥️"
type: "tech"
topics: ["ai", "go", "agent", "api"]
published: true
---

この記事はアドベントカレンダー「[Goで作るセキュリティ分析LLMエージェント](https://adventar.org/calendars/11354)」の24日目です。

- 本アドベントカレンダーでは、これまでセキュリティ分析LLMエージェントを開発のしやすさの観点から、CLI上で動作するように実装してきた
- しかし実際のセキュリティ分析業務においてはやはりCLIでは不便なことが多く、あまり実用的ではない
- これをオンラインシステムに組み込む実装について全て説明するのはあまりにも長いので本アドベントカレンダーでは触れない
- その代わりといってはなんだが、今回の記事ではwarrenに付いて説明する
  - [warren](https://github.com/secmon-lab/warren)は実際にLLMエージェントを組み込んだセキュリティアラートの管理および分析のオンラインシステム
  - ここまで解説してきたLLMエージェントに関する実装の知識をベースに、オンラインシステムをどのように実装すると業務に活かせそうかという観点を解説する

# アラート管理とアラート分析システムの統合

- まずそもそもこの2つを統合する意味はあるのかについて整理
  - アラート分析はこれまでの記事で解説してきたやつ
    - アラートに関連する情報を各所から集めて、必要に応じて深堀りし、最終的に集めた情報をもとにアラートによる影響を判断すること
  - アラート管理とは？
    - アラートとして発報されたものの対応状況を記録管理するもの
    - ステータスはどうか？ 対応中？ 対応完了？
    - 結論はどうだったか？ 誤検知？ 検知は正常だが影響なし？ それとも実際に影響が見られた？
    - エスカレーションされた？ インシデントレスポンスとして別システムで対応された？
      - もちろんIRまでカバーするアラート管理システムもあるが、一旦「アラート管理」は影響のあるインシデントかどうかの判断まで
      - インシデント管理システムは別立てしている場合もあるしね
- 従来だとこの2つはそれぞれ別々で構築運用されていた
  - アラート管理はチケットシステムやSIEM上のアラート情報などでの管理
  - 分析はSOAR（Security Orchestration Automation and Response）でのワークフローやSIEM（Security Information and Event Manager）上での検索などで実現
- 従来の業務フローを考えるとそれでも良かった
  - 分析はSOARで一部自動化されるものの、ほぼ必ず人間の手が介入するので無理に統合している必要はなかった
  - 人間が対応する部分は直接的にアラートと紐づけて記録されるものではないし、記録したところであまり活用の道筋はなかった
    - 初心者が熟練者の作業を見るみたいなことはありえるかもだが、それもどちらかというと実地で作業記録を見たりするのは稀と考えられる
- これがLLMエージェントを利用するといろいろと話しが変わってくる
  - 分析の過程が容易に記録でき、その記録を利活用できる（記憶システムなど）
  - アラート（あるいはアラートを管理するチケット）と密結合していることで、情報の注入などが用意になる（プロンプトエンジニアリング）
  - アラートそのものへの操作として、アノテーションなどもエージェントにやらせることができる（Function Calling）
  - そもそも対応する対象と対応状況の記録を密結合させることで、アラート発出後の対応の見通しがよくなる
- などの観点からAIエージェント活用側面では管理および分析を統合する価値が高い
  - ちなみにインシデント対応についても同じような価値を発揮できる可能性があるが、残念ながら筆者はそのようなインシデントに相まみえる機会が今のところ少ないので言及は避ける

# アラート管理・分析システムの要件

要件について簡単にまとめる

- アラートを受信したい
  - アラート管理・分析システムは自身でアラートを発見する機能は持たない
  - とすると外部のセキュリティ監視・防御システムであったり、SaaS（例えばGoogle Workspaceとか）のセキュリティアラートを受け取りたい
  - 受け取る方法は様々だがWebhook APIの口が用意されていればだいたいなんとかなる
  - SQSであったりPub/Subのリクエストを受け取れるようにしておくとさらに融通がきく
    - こちらからAPIでpullしないといけないやつもスクリプトなどで取得して流し込めばいいし
  - ポイントとしてはアラートを受信した際にいろいろ処理をしたい（ワークフロー）
    - まずアラートも処理しやすい形で投げ込まれるとは限らない
    - １メッセージに複数アラートが含まれるなんて言うのもあるので変換などが必要（ingest）
    - さらに受診時に必要な情報を付与したり（enrich）不要そうなら閉じるという対応（triage）をしてほしい
    - これをAPI経由でアラートを受けたときに一連の動作として実行する
- アラートを対応・分析したい
  - 対応・分析は、まずなるべく使い慣れたツールでやりたい
    - 独自UIでもいいんだけどやはり使い慣れているものがやりやすい
    - 通知を受けたあとにいちいち別のシステムに遷移するのも面倒
    - ただし記録自体はシステム内にちゃんと閉じ込めたい
  - 関係者とコミュニケーションが取りやすい仕組みがよい
    - アラート対応の業務の体感1/3〜1/2は「人に聞く」
      - false positiveの可能性を確認する
      - 正規の手続きで意図的にやったことなのか確認する
      - 影響の有無を判断するために状況や環境の情報を聞く
    - 独自UIだとそっちに関係者を誘導しないといけない
      - 関係者は当然ながｒセキュリティに関係しない人を含むというか、むしろ99%そっち
      - そうするとその人達むけにもアカウント用意したりみたいなことが発生して非常に手間。物によってはライセンス数の問題とかもある
      - あと単純にコミュニケーションが途切れると面倒。例えばSlack上で話していたことをもう一度転記したりみたいなのはだるい
    - ということでシームレスにコミュニケーションをとれるのがよい
- アラートを管理したい
  - 先述した通りアラートがどういう状況かをちゃんと把握したい
    - アラートそのものの状況（未対応、対応中、対応完了）や影響度の判断
    - 誰が担当しているのかもわかりやすく
    - 対応でどのような過程を辿ったのかも記録すべき
  - ここででてくるのが似たようなアラートの処理
    - Embeddingの際にも話たが似たようなアラートが大量に出たときにそれを個別に対応しないといけないと本当にだるい
    - こういうのを一括で処理できるようにしたいよね

# AIネイティブなアラート管理・分析システム：Warren

ということで実際に実装したのがこれ

https://github.com/secmon-lab/warren

## アラート受信

![](https://storage.googleapis.com/zenn-user-upload/bfd53171cff8-20251221.png)
_受信したアラートについてSlackへ通知が送信される_

- APIは一般的なWebhookやPub/Sub、SNSへの対応のみ
- ワークフローについては以前に解説したものとほぼ同様なので省略
- 事前に定義したenrichおよびtriageのポリシーに基づいて通知を抑制したり、そもそもアラートとして取り扱わない（無視）するというようなことも可能
  - 例えばセキュリティ監視のアラートについては無視するのが怖い
  - いっぽうでセキュリティ関連のニュース記事をアラートと見立てて処理することも可能
    - RSSフィードを受信したらAPIへPostするものを別途用意する
    - プロンプトで自組織の状況、使っている技術スタックやツールなどの情報を与えておき、全く関係ない記事は無視させるとかもできる
- セキュリティ監視のアラートについても事前に調査するエージェントを実行しておくこともできる
  - ただしアラートが頻発したときに、外部APIをたたくレートリミットにヒットしないかだけ注意が必要である

## アラート分析

![](https://storage.googleapis.com/zenn-user-upload/e8a73dcfbf47-20251221.png)
_Slackのスレッド内でエージェントと会話形式で指示が可能_

![](https://storage.googleapis.com/zenn-user-upload/8441b7562bb4-20251221.png)
_質問されたことに対して結論が得られたら報告してくれる_

- 分析については、まさにこれまで実装してきたLLMエージェントと同等の機能
- ボットをあらかじめ用意しておき、それに対してメンションすると必要な情報をかき集めてくれる
  - 設定したツールに応じて計画を立てて実行してくれる（Plan&Execute）
  - 図の例だと脅威情報を集めているだけだが、ログ検索や実行もしてくれる（BigQueryツールとサブエージェント実装）
- エージェントの結論自体をそのまま採用する必要はないが、一般知識も交えた回答をしてくれる
  - より精度の高い回答をさせたい場合は、組織の状況をシステムプロンプトに組み込んでおくとよい（プロンプトエンジニアリング）

## アラート管理

![](https://storage.googleapis.com/zenn-user-upload/5696d8e6495a-20251221.png)
_Webインターフェイスにおけるダッシュボード_

- アラートの管理という側面ではWeb UIを活用したほうがよい
  - Slackはフロー的に情報を扱うのには適しているが、ストック的に扱うのはやはり難しい
  - 大量のアラートを処理したり、残アラートを確認したり、対応の記録を見たりするなどは専用UIの方が自由度が高い
  - 今までであればユーザインタフェースをSlackとWeb両方に持つみたいなのはメンテコストが高くてアンチパターンだった
  - しかし生成AIコーディングの躍進により、現実的な工数で両方を維持することができるようになった
  - インタラクティブなやり取りや、他の組織内メンバーとのやりとりなどはSlackに圧倒的な利があるが、その他はWeb UIを活用するのがよい
  - 特殊な操作をするインターフェイスもWeb UIの自由度の高さに利点がある

![](https://storage.googleapis.com/zenn-user-upload/8d2427a643d2-20251221.png)
_例としてアラートを事前に類似度でクラスタリングして、まとめて起票するといったインターフェイスも用意できる_

- Warrenはアラートを「チケット」という単位で管理している
  - チケットは1つ以上のアラートを紐づける。服薄のアラートを紐づけることも可能
  - チケットはあくまで対応の単位
  - そのため同じ事象を指していると見られるアラートをまとめることで、
  - "Bind" という機能によって一つずつ
- もちろん先程説明した通り、一括で対応したいというケースがある
  - これをEmbeddingを利用した類似度検索およびフィルタによって（Embeddingの回で解説したやつ）

![](https://storage.googleapis.com/zenn-user-upload/6025c4cebc92-20251221.png)

# Warrenの実運用に関する所感

- これは実際に業務内でも利用している
  - 自分のようにある程度セキュリティ分析ができるメンバーであれば分析業務の大幅な省力化になる
    - 脅威情報を調べたりというのも簡単ではあるが一定は手間
    - 特に強烈なのがログ検索
      - 自分の業務環境だとBigQueryに全てのログが入っている
      - スキーマが大きすぎて全く人間には覚えられない
        - そのためこれまではrunbookのようなSQLをあらかじめ用意し、人間がちまちま編集して使っていた
        - これをスキーマとrunbook、分析目的をあたえればLLMが全部自動でやってくれるようになったのがハチャメチャに楽になった
        - 分析に際して「重い腰を上げる」みたいなことが激減した
    - 正直、一度このLLMエージェントでの分析に慣れてしまうと人手だけでやる気にはなれない
  - セキュリティ分析が専門ではないメンバーも（一定サポートはしつつも）分析業務ができるようになってきた
    - 最終的な判断について助言したりなどはあるが、あやしいものや判断に悩むものをエスカレーションしてもらうことでうまく機能している
    - 特にSlackやGitHubから社内活動の情報を拾ってきてそれが正規の動作化などを確認することもできるようになっている（それらのツールを用意している）のもかなり助けになっている
- 銀の弾丸のようにみえるかもだが、実際にはまだまだ改良の余地がある
  - ツールの充実度や実行計画を精錬させるなどやることはたくさんある
  - また新しい機能もいろいろ挑戦したいものもある
  - LLM自体の進化も激しいため、それをキャッチアップしながらより便利なものを作っていきたい

# まとめ

